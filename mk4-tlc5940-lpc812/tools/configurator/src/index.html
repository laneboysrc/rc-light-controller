<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RC Light Controller configuration tool</title>

  <link inline rel="stylesheet" href="vendor/codemirror/lib/codemirror.css">
  <link inline rel="stylesheet" href="vendor/codemirror/theme/monokai.css">
  <link inline rel="stylesheet" href="vendor/codemirror/addon/display/fullscreen.css">
  <link inline rel="stylesheet" href="vendor/codemirror/addon/dialog/dialog.css">
  <link inline rel="stylesheet" href="vendor/codemirror/addon/lint/lint.css">

  <link inline rel="stylesheet" href="../node_modules/font-awesome-base64/index.css">

  <link inline rel="stylesheet" href="configurator.css">

  <script inline src="vendor/FileSaver.js/FileSaver.js"></script>

  <script inline src="vendor/intel-hex/intel-hex.js"></script>

  <script inline src="vendor/codemirror/lib/codemirror.js"></script>
  <script inline src="vendor/codemirror/addon/dialog/dialog.js"></script>
  <script inline src="vendor/codemirror/addon/selection/active-line.js"></script>
  <script inline src="vendor/codemirror/addon/edit/closebrackets.js"></script>
  <script inline src="vendor/codemirror/addon/search/search.js"></script>
  <script inline src="vendor/codemirror/addon/search/searchcursor.js"></script>
  <script inline src="vendor/codemirror/addon/display/fullscreen.js"></script>
  <script inline src="vendor/codemirror/addon/display/placeholder.js"></script>
  <script inline src="vendor/codemirror/addon/lint/lint.js"></script>
  <script inline src="vendor/codemirror/addon/comment/comment.js"></script>
  <script inline src="vendor/codemirror/keymap/sublime.js"></script>

  <script inline src="codemirror-mode-light-program/light-program.js"></script>

  <script inline src="../../light-program-assembler/build/parser.js"></script>
  <script inline src="../../light-program-assembler/symbols.js"></script>
  <script inline src="../../light-program-assembler/emitter.js"></script>
  <script inline src="../../light-program-assembler/log.js"></script>
  <script inline src="../../light-program-assembler/disassembler.js"></script>

  <script inline src="default_firmware_image_mk4.js"></script>
  <script inline src="config_hardware_test.js"></script>
  <script inline src="config_preprocessor.js"></script>

  <script inline src="gamma.js"></script>

  <script inline src="webusb.js"></script>
  <script inline src="lpc81x_isp.js"></script>
  <script inline src="preprocessor-simulator.js"></script>
  <script inline src="preprocessor-simulator-ui.js"></script>

  <script inline src="templating.js"></script>
  <!-- <script NOinline src="chrome_uart.js"></script> -->
  <!-- <script NOinline src="flash_lpc8xx.js"></script> -->
  <!-- <script NOinline src="flash_dfu.js"></script> -->
  <script inline src="ui.js"></script>
  <script inline src="main.js"></script>
</head>
<body>

  <div id="heading" class="widebox menu_bar">
    <button id="load" class="menu" title="Load a configuration or firmware image file"><i class="fa fa-arrow-circle-o-up"></i><br>Load</button>
    <button id="save_config" class="menu" title="Save configuration file"><i class="fa fa-arrow-circle-o-down"></i><br>Save config</button>
    <button id="save_firmware" class="menu" title="Save the firmware image"><i class="fa fa-arrow-circle-o-down"></i><br>Save firmware</button>
    <button id="flash" class="menu hidden" title="Flash the firmware into the light controller"><i class="fa fa-download"></i><br>Flash</button>
    <button id="read" class="menu hidden" title="Read the configuration from the light controller"><i class="fa fa-upload"></i><br>Read</button>
  </div>


  <div id="runtime-error" style="display: none; margin: 10px; padding: 10px; background: red; color: white">
    <h1 style="color: white">ATTENTION</h1>
    <strong>
      The Light Program parser is not present.<br>
      This means that you are most likely trying to run a source file meant for development
      rather than the actual &quot;configurator.html&quot; program.
      <br>&nbsp;<br>
      You can obtain the correct &quot;configurator.html&quot; at <a href="https://github.com/laneboysrc/rc-light-controller/blob/master/mk4-tlc5940-lpc812/mk4-download-me.zip?raw=true" target="_blank">https://github.com/laneboysrc/rc-light-controller/blob/master/mk4-tlc5940-lpc812/mk4-download-me.zip</a>
      <br>&nbsp;<br>
    </strong>
      To fix this error during development, change to the &quot;tools/light-program-assembler/&quot; directory and run &quot;make&quot;.
  </div>

  <div class="body">

    <nav class="menu box">
      <ul>
        <li><button data-page="config_hardware"><i class="fa fa-hdd-o"></i><span class="menu-label">Hardware</span></button></li>
        <li><button data-page="config_mode"><i class="fa fa-wrench"></i><span class="menu-label">Operating mode</span></button></li>
        <li><button data-page="config_esc"><i class="fa fa-car"></i><span class="menu-label">ESC type</span></button></li>
        <li><button data-page="config_ch3"><i class="fa fa-toggle-on"></i><span class="menu-label">CH3/AUX configuration</span></button></li>
        <li><button data-page="config_reversing"><i class="fa fa-arrows-h"></i><span class="menu-label">Reversing</span></button></li>
        <li><button data-page="config_output"><i class="fa fa-external-link"></i><span class="menu-label">Output functions</span></button></li>
        <li><button data-page="config_leds"><i class="fa fa-lightbulb-o"></i><span class="menu-label">LED configuration</span></button></li>
        <li><button data-page="config_light_programs"><i class="fa fa-code"></i><span class="menu-label">Light programs</span></button></li>
        <li><button data-page="config_advanced"><i class="fa fa-cogs"></i><span class="menu-label">Advanced settings</span></button></li>
        <li><button data-page="tab_programming"><i class="fa fa-microchip"></i><span class="menu-label">Programming</span></button></li>
        <li><button data-page="tab_testing"><i class="fa fa-sliders"></i><span class="menu-label">Testing</span></button></li>
        <li><button data-page="info"><i class="fa fa-info-circle"></i><span class="menu-label">Info</span></button></li>
      </ul>
    </nav>

    <div class="page" id="main">
      <div id="config_hardware" class="box configuration hidden">
        <h1><span id="logo"></span> RC Light Controller configuration tool</h1>

        <div>
          Configurator version: <strong>#{this.date}</strong><br>
          Firmware version: <strong><span id="firmware_version"></span></strong>
        </div>

        <div>
        This tool is part of the LANE Boys RC Light Controller documented at <a href="https://github.com/laneboysrc/rc-light-controller" target="_blank">https://github.com/laneboysrc/rc-light-controller</a>.
        </div>

        <div>
          <select class="hidden" id="hardware">
            <option value="mk4">Mk4 (NXP LPC812)</option>
          </select>
          <span id="hardware_image" class="mk4"></span>
        </div>

        <div>
          For more information please refer to the user manual:
          <br>
          <a href="https://laneboysrc.github.io/rc-light-controller/light-controller-instructions-mk4.pdf" target="_blank">Mk4 Light Controller documentation</a> (PDF)
          <br>
          <a href="https://laneboysrc.github.io/rc-light-controller/light-controller-instructions-mk4-deutsch.pdf" target="_blank">Mk4 Light Controller Anleitung</a> (Deutsch, PDF)
        </div>

        <div class="info">
          <h2>Quick start</h2>
          <div>
            Using the menu on the left you can adjust the configuration to suit
            your vehicle and RC system.
          </div>
          <div>
            After you are done, you can save the firmware image, which will have
            the selected configuration embedded. The firmware will be stored in
            the download folder of your web browser.
          </div>
          <div>
            Flash the firmware into the light controller as described in the
            light controller user manual.
          </div>
          <div>
            You can also save the configuration into a text file, which
            can be loaded at a later point in time; for example to make
            further tweaks.
          </div>
          <div>
            <strong>It is advisable that you always save a copy of the
            configuration for future reference.</strong> While it is possible
            to retrieve all settings from a firmware image, some data like
            variable names and comments in light programs are lost as they are
            not stored into the firmware.
          </div>
        </div>
      </div>


      <div id="config_mode" class="box configuration hidden">
        <h2>Operating mode</h2>
        <div>
          <select id="mode">
            <option value="0">Master, servo inputs</option>
            <option value="1">Master, Pre-Processor input</option>
            <option value="98" class="v2_show" >Master, 5ch Pre-Processor input</option>
            <option value="2" class="v2_hide">Master, CPPM input</option>
            <option value="3">Slave</option>
            <option value="97">Pre-Processor</option>
            <option value="96" class="v2_show">Pre-Processor 5ch</option>
            <option value="95" class="v2_show">Pre-Processor 5ch with switching outputs</option>
            <option value="4" class="v2_show">Stand-alone mode</option>
            <option value="99">Hardware test</option>
          </select>
        </div>
        <div id="mode_master_servo" class="info">
          <div>
            The light controller reads servo signals from the receiver. The
            steering signal must be connected to input <strong>ST/Rx</strong> on
            the light controller, the throttle signal to <strong>TH/Tx</strong>
            and the Channel 3 (AUX) signal to the <strong>CH3</strong> input.
          </div>
        </div>
        <div id="mode_master_uart" class="info">
          <div>
            In this mode, the light controller does not read servo signals directly, but from a
            <em>Pre-Processor</em>. The <em>Pre-Processor</em> is a
            small, separate circuit board that connects to the receiver and
            converts the servo signals into a serial data stream. The light
            controller can be connected to the <em>Pre-Processor</em> with a single
            servo extension cable. This simplifies wiring of a RC car, especially
            when the light controller resides on the body while the receiver is
            mounted on the chassis.
          </div>
          <div>
            The <strong>Light</strong> output from the <em>Pre-Processor</em> must be connected to the
            <strong>ST/Rx</strong> input of the light controller.
          </div>
        </div>
        <div id="mode_master_uart_5ch" class="info">
          <div>
            In this mode, the light controller does not read servo signals directly, but from a
            <em>Pre-Processor</em>. This particular mode requires the
            <em>5-channel Pre-Processor</em> circuit board, which is capable of reading up
            to five servo channels from a receiver.
            The <em>5-channel Pre-Processor</em> combines the servo signals into
            a serial data stream so that the light controller can be
            connected with a single servo extension cable.
          </div>
          <div>
            The <strong>Light</strong> output from the <em>5-channel Pre-Processor</em>
            must be connected to the <strong>ST/Rx</strong> input of the
            light controller.
          </div>
        </div>
        <div id="mode_master_cppm" class="info">
          <div>
            Some receiver have a CPPM output, which encodes information of all
            servos in a single electrical signal. The light controller can read
            this signal, so only a single cable needs to be connected from the
            receiver to the light controller.
          </div>
          <div>
            Please consult your the instructions of your RC system to check
            whether your receiver has a CPPM output.
          </div>
        </div>
        <div id="mode_slave" class="info">
          <div>
            In case more than 16 LEDs are required, it is possible to daisy-chain
            two light controllers. One needs to be configured as <em>master</em>
            and have the <em>Slave output</em> activated, the other one
            must be configured as <em>slave</em>, for a total of 32 LEDs.
          </div>
          <div>
            The output from the <em>master</em> must be fed into the
            <strong>ST/Rx</strong> input on the <em>slave</em>.
          </div>
          <div>
            The <em>master</em> controls the light functions of both light
            controllers. Ensure that the baudrate of both <em>master</em> and
            <em>slave</em> match.
          </div>
        </div>
        <div id="mode_stand_alone" class="info">
          <div>
            The light controller can operate without any RC system being
            connected. This is useful for non-RC applications such as lighting
            up doll-houses or model railways.
          </div>
          <div>
            In this mode you would either program the light controller for
            automatic operation using the <em>light programs</em>, and/or use
            a push-button connected to the <strong>CH3</strong> input.
          </div>
        </div>
        <div id="mode_preprocessor" class="info">
          <div>
            Choosing this mode creates a firmware that is suitable for flashing
            into the <em>Pre-Processor</em>.
          </div>
        </div>
        <div id="mode_preprocessor_5ch" class="info">
          <div>
            Choosing this mode creates a firmware that is suitable for flashing
            into the <em>5-channel Pre-Processor</em>.
          </div>
        </div>
        <div id="mode_preprocessor_5ch_s" class="info">
          <div>
            Choosing this mode creates a firmware that is suitable for flashing
            into the <em>5-channel Pre-Processor with integrated switching outputs</em>.
          </div>
          <div>
            <strong>Important:</strong> In most cases you will want to configure
            the light controller output in the <em>Output functions</em> tab
            either for <em>Slave output</em> or <em>Pre-Processor output</em>.
          </div>
        </div>
        <div id="mode_test" class="info">
          <div>
            Generates a firmware image suitable for hardware test. As soon as
            power is applied, the LEDs flash in test sequence.
          </div>
        </div>

        <div id="config_baudrate" class="configuration">
          <h3>Baudrate</h3>
          <div>
            <select id="baudrate">
              <option value="38400">38400</option>
              <option value="115200">115200</option>
            </select>
          </div>
          <br>
          The baudrate for serial input/output functions. This applies to the
          Pre-Processor input and output, and the slave input and output.
          <br>
          Ensure that master and slave are using the same baudrate.
        </div>
      </div>


      <div id="config_esc" class="box configuration hidden">
        <h2>ESC type</h2>
        <div>
          <div class="radio_item">
            <input type="radio" name="esc" value="0" id="esc_fbr_with_timeout">
            <label for="esc_fbr_with_timeout">Forward/Brake/Reverse (with timeout)</label>
            <br>
            After going forward, the ESC allows going in reverse when the throttle
            has been in neutral for a certain amount of time.
            <br>
            Examples: HPI SC-15WP, HobbyKing HK-SENS-60A
          </div>
          <div class="radio_item">
            <input type="radio" name="esc" value="1" id="esc_fbr_no_timeout">
            <label for="esc_fbr_no_timeout">Forward/Brake/Reverse (no timeout)</label>
            <br>
            After going forward, the first push backwards on the throttle is
            always engagin the brake function, regardless whether the throttle
            has been in neutral for a long time. The second push on the throttle
            engages reverse function. Note: the timeout can be adjusted in the
            advanced configuration section below.
            <br>
            Examples: Tamiya TEU-104BK, TEU-105BK.
          </div>
          <div class="radio_item">
            <input type="radio" name="esc" value="2" id="esc_fr">
            <label for="esc_fr">Forward/Reverse (crawler mode)</label>
            <br>
            Forward and reverse engage immediately when the throttle is moved
            to the corresponding position. Many ESC call this behaviour a &quot;crawler mode&quot;
          </div>
          <div class="radio_item">
            <input type="radio" name="esc" value="3" id="esc_fb">
            <label for="esc_fb">Forward/Brake (racing mode)</label>
            <br>
            For racing purpose some ESC can be configured to disable reverse.
          </div>
        </div>
      </div>


      <div id="config_ch3" class="box configuration hidden">
        <div id="aux_3ch">
          <h2>CH3/AUX type</h2>
          <div>
            <div class="radio_item">
              <input type="radio" name="ch3" value="0" id="ch3_two_position">
              <label for="ch3_two_position">Two-position switch</label>
              <br>
              The CH3/AUX function on the transmitter is either a two-position
              switch, or a toggle button that moves the servo between two endpoints.
              <br>
              Examples: FlySky GT3 series, HobbyKing HK310
            </div>
            <div class="radio_item">
              <input type="radio" name="ch3" value="1" id="ch3_two_position_up_down">
              <label for="ch3_two_position">Two-position switch with up/down buttons</label>
              <br>
              The CH3/AUX function on the transmitter has two positions that are selected
              with two buttons on the transmitter. Pressing the down button moves
              to position 1, pressing the up button moves to position 2.
              <br>
              Selecting this option requires to always press the down button first before
              entering the desired number of clicks
              <br>
              Examples: HobbyKing X3S, Tactic TTX300
            </div>
            <div class="radio_item">
              <input type="radio" name="ch3" value="2" id="ch3_momentary">
              <label for="ch3_momentary">Momentary push button</label>
              <br>
              The CH3/AUX function on the transmitter is a push button that moves
              the servo to the opposite endpoint while the button is pushed, but
              moves the servo back to the original position once the button is
              released.
              <br>
              Examples: Futaba 4PL
            </div>
            <div class="radio_item">
              <input type="radio" name="ch3" value="3" id="ch3_local">
              <label for="ch3_local">Push button on the light controller</label>
              <br>
              A push button directly connected to the light controller's CH3 input
              (i.e. a physical button, not a servo signal from the receiver).
              Useful for 2-channel radios.
            </div>
          </div>
        </div>
        <div id="multi_aux">
          <h2>AUX configuration</h2>
          <div>
            <label for="aux_type">AUX type</label> <select id="aux_type">
              <option value="0">Two-position switch</option>
              <option value="1">Two-position switch, up/down buttons</option>
              <option value="2">Momentary push button</option>
              <option value="3">Three-position switch</option>
              <option value="4">Analog control</option>
            </select>
            <label for="aux_function">Function</label> <select id="aux_function">
              <option class="function_not_used" value="0">Not used</option>
              <option class="function_multi_function" value="1">Multi-function control</option>
              <!-- <option value="2">Gearbox</option> -->
              <!-- <option value="3">Winch</option> -->
              <option class="function_servo" value="4">Servo control</option>
              <option class="function_indicators" value="5">Indicators</option>
              <option class="function_hazard" value="6">Hazard lights on/off</option>
              <option class="function_light_switch" value="7">Light switch</option>
              <option class="function_disable_outputs" value="8">Disable outputs</option>
            </select>
          </div>
          <br>
          <div>
            <label for="aux2_type">AUX2 type</label> <select id="aux2_type">
              <option value="0">Two-position switch</option>
              <option value="1">Two-position switch, up/down buttons</option>
              <option value="2">Momentary push button</option>
              <option value="3">Three-position switch</option>
              <option value="4">Analog control</option>
            </select>
            <label for="aux2_function">Function</label> <select id="aux2_function">
              <option class="function_not_used" value="0">Not used</option>
              <option class="function_multi_function" value="1">Multi-function control</option>
              <!-- <option value="2">Gearbox</option> -->
              <!-- <option value="3">Winch</option> -->
              <option class="function_servo" value="4">Servo control</option>
              <option class="function_indicators" value="5">Indicators</option>
              <option class="function_hazard" value="6">Hazard lights on/off</option>
              <option class="function_light_switch" value="7">Light switch</option>
              <option class="function_disable_outputs" value="8">Disable outputs</option>
            </select>
          </div>
          <br>
          <div>
            <label for="aux3_type">AUX3 type</label> <select id="aux3_type">
              <option value="0">Two-position switch</option>
              <option value="1">Two-position switch, up/down buttons</option>
              <option value="2">Momentary push button</option>
              <option value="3">Three-position switch</option>
              <option value="4">Analog control</option>
            </select>
            <label for="aux3_function">Function</label> <select id="aux3_function">
              <option class="function_not_used" value="0">Not used</option>
              <option class="function_multi_function" value="1">Multi-function control</option>
              <!-- <option value="2">Gearbox</option> -->
              <!-- <option value="3">Winch</option> -->
              <option class="function_servo" value="4">Servo control</option>
              <option class="function_indicators" value="5">Indicators</option>
              <option class="function_hazard" value="6">Hazard lights on/off</option>
              <option class="function_light_switch" value="7">Light switch</option>
              <option class="function_disable_outputs" value="8">Disable outputs</option>
            </select>
          </div>
          <br>
          <hr>
          <br>
          <div>
            <strong>Not used:</strong> Use this setting if you want to use this
            AUX input within a light program, instead of one of the pre-defined
            functions.
          </div>
          <br>
          <div>
            <strong>Multi-function:</strong> 1-click is &quot;more lights&quot;; 2-clicks
            is &quot;less lights&quot;; 3-clicks
            is &quot;toggle lights on/off&quot;; 4-clicks
            is &quot;hazard lights on/off&quot; ...
          </div>
          <br>
          <div>
            <strong>Servo control:</strong> Control a servo connected to the light
            controller output from this AUX channel. Note that the servo end points,
            center position and reversing can be adjusted using 7-clicks.
            <br>
            This function is only applicable when <em>Steering wheel servo ouput</em>
            is enabled in the <em>Output functions</em> tab.
          </div>
          <br>
          <div>
            <strong>Indicators:</strong> Manually control the indicators. Disables
            the automatic indicator functionality of the light controller.
          </div>
          <br>
          <div>
            <strong>Hazard lights on/off:</strong> Manually control hazard lights.
          </div>
          <br>
          <div>
            <strong>Light switch:</strong> Control the virtual light switch, as
            configured in the <em>LED configuration</em> tab, directly from
            an AUX channel. Your AUX channel should have at least as many positions
            as you have light switch positions in use.
          </div>
          <br>
          <div>
            <strong>Disable outputs:</strong> When the corresponding AUX channel outputs a
            servo pulse of larger than 1.75 ms then all light outputs are turned off.
            This allows you to disable all manual and automatic light functions from
            the transmitter.
          </div>
        </div>
      </div>

      <div id="config_reversing" class="box configuration hidden">
        <h2>Channel reversing</h2>
        <div>
          <input type="checkbox" id="reverse_st">
          <label for="reverse_st">Reverse ST (Steering)</label>
        </div>
        <div>
          <input type="checkbox" id="reverse_th">
          <label for="reverse_th">Reverse TH (Throttle)</label>
        </div>

        <div id="channel_reversing_multi_aux" class="configuration">
          <div>
            <input type="checkbox" id="reverse_aux">
            <label for="reverse_aux">Reverse CH3/AUX</label>
          </div>
          <div>
            <input type="checkbox" id="reverse_aux2">
            <label for="reverse_aux2">Reverse AUX2</label>
          </div>
          <div>
            <input type="checkbox" id="reverse_aux3">
            <label for="reverse_aux3">Reverse AUX3</label>
          </div>
        </div>

        <div class="info">
          Note that steering and throttle reversing can also be configured from the transmitter once the light controller is installed, by entering 7-clicks on CH3/AUX. For more details please refer to the <a href="https://laneboysrc.github.io/rc-light-controller/light-controller-instructions-mk4.pdf" target="_blank">Mk4 Light Controller documentation</a> (PDF).
        </div>


        <h2 class="space_before">OUT15S control</h2>
        <div>
          <input type="checkbox" id="invert_out15s">
          <label for="invert_out15s">Invert OUT15S</label>
        </div>
        <div class="info">
          The switched light output OUT15S follows LED output OUT15. When OUT15 is on,
          OUT15S is on as well, which means that the output pin is pulled to GND (supply minus).
        </div>
        <div class="info">
          When this checkbox is enabled, the operation of OUT15S is inverted. This means when
          OUT15 is on at any brightness, then OUT15S will be now off. But when OUT15 is off (value 0), then OUT15S will be on (pin pulled to GND).
          <br>
          This can be useful to control an external DC/DC converter with an enable pin.
        </div>
      </div>



      <div id="config_output" class="box configuration hidden">
        <div class="dual_output">
          <h2>Pin assignment</h2>
          <div class="radio_item">
          When a Pre-Processor is used, the TH/Tx pin is available as second output of the light controller. The light controller can output one servo signal, and one UART signal (serial port; for example to connect a slave light controller).
          <br>
          You can choose which of the pins receives the Servo signal. Functionality-wise it makes no difference, but it may make wiring easier.
          </div>
          <div>
            <input type="radio" name="assign_servo_uart" value="" id="assign_servo_to_out">
            <label for="assign_servo_to_out">Servo on OUT/ISP, UART on TH/Tx</label>
          </div>
          <div class="radio_item">
            <input type="radio" name="assign_servo_uart" value="1" id="assign_uart_to_out">
            <label for="assign_uart_to_out">Servo on TH/Tx, UART on OUT/ISP</label>
          </div>
        </div>
        <h2 class="single_output">Output function on pin OUT/ISP</h2>
        <h2 class="dual_output">Servo output function</h2>
        <div>
          <div class="radio_item">
            <input type="radio" name="output_out" value="0" id="single_off">
            <label for="single_off">(no output function)</label>
            <br>
            The light controller does not output a signal
            <span class="single_output">on pin OUT/ISP.</span>
            <span class="dual_output">on the pin assigned to the servo function.</span>
          </div>
          <div class="radio_item">
            <input type="radio" name="output_out" value="3" id="steering_wheel_servo_output">
            <label for="steering_wheel_servo_output">Steering wheel servo output</label>
            <br>
            The light controller can be connected to a servo, that moves the
            steering wheel in the cabin of the car. The output follows the
            steering input, but the endpoints and direction can be configured
            independently of the steering function of the car.
          </div>
          <div class="radio_item">
            <input type="radio" name="output_out" value="4" id="gearbox_servo_output">
            <label for="gearbox_servo_output">Gearbox servo output</label>
            <br>
            When enabled, a servo signal is generated that allows control of a
            two-speed or three-speed gearbox.
            <br>
            <label for="number_of_gears">Number of gears:</label> <select id="number_of_gears">
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <br>
            <input type="checkbox" name="gearbox_light_program_control" value="1" id="gearbox_light_program_control">
            <label for="gearbox_light_program_control">Control the gearbox through light programs</label>
            <br>
            When enabled, the gearbox can be controlled from light programs only,
            and not via 1- or 2-clicks on CH3.
          </div>
          <div class="radio_item">
            <input type="radio" name="output_out" value="5" id="light_program_servo_output">
            <label for="light_program_servo_output">Servo controlled from light programs</label>
            <br>
            This function can be useful to control sequences of servo positions,
            or for example to randomize head movements of a figure.
          </div>
        </div>
        <h3 class="dual_output">UART output function</h3>
        <div class="radio_item dual_output">
          <input type="radio" name="output_th" value="0" id="dual_off">
          <label for="dual_off">(no output function)</label>
          <br>
          No signal on the pin assigned to the UART function.
        </div>
        <div class="radio_item">
          <input class="dual_output_th" type="radio" name="output_out" value="1" id="slave_output">
          <label for="slave_output">Slave output</label>
          <br>
          By using a second light controller configured as <em>slave</em>
          a total of 32 LEDs can be controlled. A single cable must be run
          between the
          <span class="single_output"><em>master</em> OUT/ISP pin</span>
          <span class="dual_output">pin on the <em>master</em> assigned to the UART function</span>
          and the <em>slave</em> ST/Rx pin.
          <br>
          When this option is selected, a second set of LED configuration
          becomes visible below.
        </div>
        <div class="radio_item">
          <input class="dual_output_th" type="radio" name="output_out" value="2" id="preprocessor_output">
          <label for="preprocessor_output">Pre-processour output</label>
          <br>
          When enabled, the light controller outputs the steering, throttle
          and CH3/AUX signals as serial data stream. This function can be
          useful for connecting custom hardware to the light controller.
        </div>
      </div>


      <div id="config_leds" class="box configuration hidden">
        <h2>LED configuration</h2>
        <div>
          Click on a field in the table to set the LED brighness value in percent for a particular function.
        </div>
        <div>
          Click on the <i class="fa fa-wrench"></i> icon to configure advanced parameters for simulating incandescent bulbs and weak ground connections.
          The background of the icon turns orange when advanced features are in use.
        </div>
        <div>
          <strong>Hover the mouse over individual items</strong> to see an explaination about their function.
        </div>
        <div>
          <button id="leds_clear">Clear...</button> Use the clear button to reset all LED configurations to off. <strong>Warning:</strong> this can not be undone; save your configuration before clearing!
        </div>
        <div id="leds_master">
          <h3>Master</h3>
          <div>
            <table class="led_table">
              <tbody>
                <tr class="even">
                  <th class="led_tab_car" colspan="3">Car functions</th>
                  <th class="led_tab_diagnostics" colspan="3">Diagnostics</th>
                  <th></th>
                </tr>
                <tr class="odd">
                  <th></th>
                  <th class="led_table_car" data-tooltip="help_led_always_on" rowspan="2">Always on</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch" colspan="9">Light switch position</th>
                  <th class="led_table_car" data-tooltip="help_led_tail"></th>
                  <th class="led_table_car" data-tooltip="help_led_brake"></th>
                  <th class="led_table_car" data-tooltip="help_led_reverse"></th>
                  <th class="led_table_car" data-tooltip="help_led_indicator" colspan="2">Indicator</th>

                  <th class="led_table_diagnostics"></th>
                  <th class="led_table_diagnostics"></th>
                  <th class="led_table_diagnostics" colspan="2">Reversing</th>
                  <th class="led_table_diagnostics" colspan="3">Servo output</th>
                </tr>
                <tr class="odd">
                  <th>LED</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">0</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">1</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">2</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">3</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">4</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">5</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">6</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">7</th>
                  <th class="led_table_car" data-tooltip="help_led_light_switch">8</th>
                  <th class="led_table_car" data-tooltip="help_led_tail">Tail</th>
                  <th class="led_table_car" data-tooltip="help_led_brake">Brake</th>
                  <th class="led_table_car" data-tooltip="help_led_reverse">Reverse</th>
                  <th class="led_table_car" data-tooltip="help_led_indicator">left</th>
                  <th class="led_table_car" data-tooltip="help_led_indicator">right</th>

                  <th class="led_table_diagnostics" data-tooltip="help_led_initializing">Initializing</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_no_signal">No signal</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_reversing_st">steering</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_reversing_th">throttle</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_servo_left">left</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_servo_centre">centre</th>
                  <th class="led_table_diagnostics" data-tooltip="help_led_servo_right">right</th>
                </tr>

                <!-- LED rows will be inserted here -->

              </table>
            </div>
          </div>

          <div id="leds_slave">
            <h3>Slave</h3>
            <div>
              <table class="led_table">
                <tr class="odd">
                  <th></th>
                  <th data-tooltip="help_led_always_on" rowspan="2">Always on</th>
                  <th data-tooltip="help_led_light_switch" colspan="9">Light switch position</th>
                  <th data-tooltip="help_led_tail"></th>
                  <th data-tooltip="help_led_brake"></th>
                  <th data-tooltip="help_led_reverse"></th>
                  <th data-tooltip="help_led_indicator" colspan="2">Indicator</th>
                </tr>
                <tr class="odd">
                  <th>LED</th>
                  <th data-tooltip="help_led_light_switch">0</th>
                  <th data-tooltip="help_led_light_switch">1</th>
                  <th data-tooltip="help_led_light_switch">2</th>
                  <th data-tooltip="help_led_light_switch">3</th>
                  <th data-tooltip="help_led_light_switch">4</th>
                  <th data-tooltip="help_led_light_switch">5</th>
                  <th data-tooltip="help_led_light_switch">6</th>
                  <th data-tooltip="help_led_light_switch">7</th>
                  <th data-tooltip="help_led_light_switch">8</th>
                  <th data-tooltip="help_led_tail">Tail</th>
                  <th data-tooltip="help_led_brake">Brake</th>
                  <th data-tooltip="help_led_reverse">Reverse</th>
                  <th data-tooltip="help_led_indicator">left</th>
                  <th data-tooltip="help_led_indicator">right</th>
                </tr>

                <!-- LED rows will be inserted here -->

              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div id="config_light_programs" class="box configuration hidden">
        <h2>Light programs</h2>
        <div>
          Light programs are small scripts that can perform custom light
          sequences. See <a href="https://github.com/laneboysrc/rc-light-controller/blob/master/mk4-tlc5940-lpc812/doc/light-programs.md" target="_blank">light-programs.md</a> for an details on the
          programming language.
        </div>
        <div>
          Press <strong>F11</strong> to toggle fullscreen mode within your browser
          window. The <a href="http://codemirror.net/demo/sublime.html" target="_blank">keybindings</a>
          are similar to the Sublime Text editor.
        </div>
        <div>
          Use the <em>Check...</em> button below the editor to perform a syntax
          check on the light programs.
        </div>
        <div class="editor">
          <textarea id="light_programs" placeholder="Enter light programs here..."></textarea>
        </div>
        <div>
          <button id="light_programs_assembler">Check...</button>
          <span id="light_programs_ok">Light programs correct! <span id="light_programs_size" class="hidden"></span></span>
        </div>
        <pre class="box error hidden" id="light_programs_errors">
        </pre>
      </div>


      <div id="config_advanced" class="box configuration hidden">
        <h2>Advanced settings</h2>
          Note: all timing values have a resolution of 20 ms.

          <h3>Initial light switch position</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="initial_light_switch_position" min="0" max="8">
              <label for="initial_light_switch_position"></label>
            </div>
            <div>
              When the car is turned on, the virtual light switch is set to the
              given position. This allows to turn the car lights on by default,
              but still be able to turn them off on demand using CH3.
            </div>
          </div>

          <h3>Automatic brake lights</h3>
          <div class="advanced_feature">
            <div>
              <input type="checkbox" id="auto_brake_lights_forward_enabled">
              <label for="auto_brake_lights_forward_enabled">Enable automatic brake lights after driving forward</label>
            </div>
            <div>
              <input type=number id="auto_brake_counter_value_forward_min">
              <label for="auto_brake_counter_value_forward_min"> .. </label>
              <input type=number id="auto_brake_counter_value_forward_max">
              <label for="auto_brake_counter_value_forward_max">min/max time in ms the brake lights should light up</label>
            </div>

            <div>
              If enabled, the light controller turns on the brake lights for a
              random amount of time every time the throttle input goes from
              forward driving to neutral.<br>
              This provides a realistic brake light effect since often the brake
              function is not engaged in scale driving, but rather we return
              the throttle to neutral and let the car coast to a stop.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type="checkbox" id="auto_brake_lights_reverse_enabled">
              <label for="auto_brake_lights_reverse_enabled">Enable automatic brake   lights after reversing</label>
            </div>
            <div>
              <input type=number id="auto_brake_counter_value_reverse_min">
              <label for="auto_brake_counter_value_reverse_min"> .. </label>
              <input type=number id="auto_brake_counter_value_reverse_max">
              <label for="auto_brake_counter_value_reverse_max">min/max time in ms the brake lights should light up</label>
            </div>

            <div>
              If enabled, the light controller turns on the brake lights for a
              random amount of time every time the throttle goes to neutral
              after reversing. This setting only takes effect when the ESC mode
              is set to Forward/Brake/Reverse or Forward/Reverse.
            </div>
          </div>


          <h3>ESC brake function</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="brake_disarm_counter_value">
              <label for="brake_disarm_counter_value">Timeout in milliseconds</label>
            </div>
            <div>
              This setting deterimes the time how long the throttle has to be
              in neutral before the ESC allows going into reverse. It only applies
              if the ESC type is <em>Forward/Brake/Reverse (with timeout)</em>.
            </div>
          </div>


          <h3>Reversing light extension</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="auto_reverse_counter_value_min">
              <label for="auto_reverse_counter_value_min"> .. </label>
              <input type=number id="auto_reverse_counter_value_max">
              <label for="auto_reverse_counter_value_max">min/max time in ms the reversing lights should be kept on</label>
            </div>
            <div>
              After driving the car in reverse, the light controller keeps the reversing lights on for a random time between the specified min/max
              after the throttle has returned to neutral. This adds realism
              as drivers usually take a short time until they disengage reverse
              gear.<br>
              The reversing lights are immediately turned off when the car
              drives forward.<br>
              This function applies only to ESC with a forward/reverse/brake or
              forward/reverse function.
            </div>
          </div>


          <h3>Indicators</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="blink_counter_value"><span class="v2_show"><label for="blink_counter_value"> .. </label><input type=number id="blink_counter_value_dark"></span>
              <label for="blink_counter_value">Indicator on/off time in ms</label>
            </div>
            <div>
              This value sets the frequency of the indicators and hazard lights.
              For most countries the indicator blink frequency is 1.5 Hz,
              which means the half-period time should be 333 ms. <span class="v2_show">Enter different numbers for the bright and dark blink period when needed, e.g. for old US cars.</span>
            </div>
          </div>

          <div class="advanced_feature v2_show">
            <div>
              <input type="checkbox" id="us_style_combined_lights">
              <label for="us_style_combined_lights">Enable US style combined tail/brake/indicators</label>
            </div>
            <div>
              When enabled, setting values for tail, brake and indicator for a particular LED enables US-style indicators. When this flag is enabled then the indicators have priority over the brake lights (= correct setting for US cars). When the flag is disabled the brake lights have priority (= behavior of early light controller versions).
            </div>
          </div>

          <div class="advanced_feature v2_show">
            <div>
              <input type="checkbox" id="indicators_while_driving">
              <label for="indicators_while_driving">Allow indicators while driving</label>
            </div>
            <div>
              By default (when this checkbox is off), the indicators can only be engaged when both steering and throttle
              are in neutral for one second, and then you turn the steering wheel.<br>
              When this checkbox is checked the indicators can be enagaged regardless off the throttle position by just
              turning the steering wheel.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="indicator_idle_time_value">
              <label for="indicator_idle_time_value">Idle time in ms before indicators engage</label>
            </div>
            <div>
              In order to prevent the indicators coming on unintentionally during
              driving, the throttle and steering must be in center for a
              specified time before the indicators can be engaged by turning
              the steering.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="indicator_off_timeout_value">
              <label for="indicator_off_timeout_value">Timeout in ms before the indicators turn off</label>
            </div>
            <div>
              When the indicators are engaged and steering is returned to neutral,
              the indicators continue to blink for the specified amount of time.<br>
              The indicators can be turned off immediately by turning the
              steering in the opposite direction.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="blink_threshold">
              <label for="blink_threshold">% steering input required to turn on the indicators</label>
            </div>
            <div>
              The steering wheel must be turned for at least the specified
              percentage of steering lock before the indicators turn on.
            </div>
          </div>

          <h3>Click behaviour</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="ch3_multi_click_timeout">
              <label for="ch3_multi_click_timeout">timeout in ms before a &quot;click&quot; is accepted on CH3/AUX</label>
            </div>
            <div>
              In order to be able to perform multiple functions on a single
              CH3/AUX input, a method of multiple clicks -- similar to the
              concept used on computers -- is employed.<br>
              The timeout value determines how quickly the light controller reacts
              to CH3/AUX. A low value means you must switch CH3/AUX quickly, but
              also that the reaction of the function engages quickly. a high
              value means you must wait longer until the light controller accepts
              the input. 300 ms works well for the LANE Boys.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type="checkbox" id="require_extra_click">
              <label for="require_extra_click">Require an extra CH3/AUX click</label>
            </div>
            <div>
              If enabled, the user has to input an additional click. So for more lights, the user has to enter 2-clicks (instead of 1 click), and so on.
              1-click has no function when the checkbox is checked.
              <br>
              Use-case: Traxxas TRX-4 where the gearbox and light controller share
              the same channel. Then the user can switch "slow" to change the gear,
              and fast (2 or more clicks) to operate the lights.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type="checkbox" id="prefer_all_lights_off">
              <label for="prefer_all_lights_off">Prefer all lights off</label>
            </div>
            <div>
              If enabled, 3-clicks turns all lights off -- unless the lights are already off,
              in which case the lights will be switched on to the highest used light switch position.
              <br>
              By default (checkbox off), 3-clicks will switch to the highest used light switch position -- except when the light switch is already at that highes position, in which case the lights will be switched off (light switch position 0)
            </div>
          </div>

          <h3>Servo input</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="initial_endpoint_delta">
              <label for="initial_endpoint_delta">Initial endpoint delta in ms</label>
            </div>

            <div>
              The light controller features automatic detection of center and
              endpoint for both steering and throttle.<br>
              This value determines how much the initial endpoint left and right
              is set from the center value after power up.<br>
              A servo pulse is usually between 1000 and 2000 ms, with 1500 ms
              being the centre. Dual-rate and end-point adjustments in the
              transmitter change the minimum and maximum received pulse duration.<br>
              A good value for the initial endpoint is 250 ms, which corresponds
              to 50% of nominal servo travel. If the light controller sees
              a signal larger than that, it automatically adjusts its
              endpoint.<br>
              If you set this value too small the lights may flicker after power
              on until you perform steering and throttle inputs, which adjust
              the endpoints to your transmitter.<br>
              If you set this value too large steering and brake signals may
              not engage properly.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="centre_threshold_low">
              <label for="centre_threshold_low"> .. </label>
              <input type=number id="centre_threshold_high">
              <label for="centre_threshold_high">% centre threshold low/high</label>
            </div>

            <div>
              In order to prevent flickering due to mis-detection of steering
              and throttle inputs, a threshold is applied before steering and
              throttle are detected as being engaged.<br>
              When the steering/throttle is in the center, it first has to be
              engaged past the high percent mark before the light controller
              accepts the input.<br>
              When returning to center, the steering/throttle value has to go
              below the low threshold before it is recognized as being in center.<br>
              Good values depend mostly on the throttle and ESC of your car. If
              the values are set to high the car may be driving already long
              before the light controller recognizes the car as being moving.
              If the values are set too low then brake and reverse lights may
              flicker when driving at very slow speeds.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="aux_centre_threshold_low">
              <label for="aux_centre_threshold_low"> .. </label>
              <input type=number id="aux_centre_threshold_high">
              <label for="aux_centre_threshold_high">threshold low/high for two-position AUX function</label>
            </div>

            <div>
              When using a 5-channel Pre-Processor, this value determines
              the switching point and hysteresis for 2-position AUX functions
              (e.g. hazard lights on/off)<br>
              Valid range: -100..+100
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="aux_left_centre_threshold_low">
              <label for="aux_left_centre_threshold_low"> .. </label>
              <input type=number id="aux_left_centre_threshold_high">
              <label for="aux_left_centre_threshold_high">threshold low/high for left-to-centre of a three-position AUX function</label>
            </div>
            <div>
              <input type=number id="aux_centre_right_threshold_low">
              <label for="aux_centre_right_threshold_low"> .. </label>
              <input type=number id="aux_centre_right_threshold_high">
              <label for="aux_centre_right_threshold_low">threshold low/high for centre-to-right of a three-position AUX function</label>
            </div>
            <div>
              When using a 5-channel Pre-Processor, this value determines
              the switching point and hysteresis for the left-to-centre and
              centre-to-right transition of 3-position AUX functions
              (e.g. manual indicators on/off).<br>
              Valid range: -100..+100<br>
              Important: the values for left-to-centre must be lower than centre-to-right.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="servo_pulse_min">
              <label for="servo_pulse_min"> .. </label>
              <input type=number id="servo_pulse_max">
              <label for="servo_pulse_max">min/max pulse duration in ms that are valid servo pulses</label>
            </div>

            <div>
              Servo signals have a nominal pulse width of 1.5 ms when in center,
              and 1.0 / 2.0 ms when at the end points. In reality servo pulses
              can go below 0.9 ms and above 2.3 ms when features like end-point
              adjustment and sub-trim are applied.
            </div>
            <div>
              The values above define what minimum and maxium pulse width a servo
              signal is allowed to have in order to consider it valid. This
              setting only applies to servo reader <span class="v2_hide">and CPPM input </span>configurations.
            </div>
            <div class="v2_hide">
              For the CPPM input the max pulse duration is the minimum idle
              idle time to identify a start of a CPPM frame.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="startup_time">
              <label for="startup_time">time in ms to delay operation</label>
            </div>

            <div>
              This value applies to servo reader <span class="v2_hide">and CPPM input </span>configurations.
              After power on, the light controller waits for the first servo
              pulse to arrive. The time given in this field determines how
              long the light controller waits after the first servo pulse until
              it in itializes neutral points of steering and throtte, and starts
              its normal operation.
            </div>
          </div>

          <div class="advanced_feature">
            <div>
              <input type=number id="no_signal_timeout">
              <label for="no_signal_timeout">no signal timeout in ms</label>
            </div>

            <div>
             If no servo signal is received within the given time, for example
             because the transmitter is out of range, then the light controller
             sets the no-signal flag internally, which can be used in light
             programs to perform a certain function.<br>
             Note that most likely this will not work well on modern digital
             transmitters, because the failsafe function will output valid servo
             signals even if the transmitter is out of range.
            </div>
          </div>

          <h3>Shelf queen mode</h3>
          <div class="advanced_feature">
            <div>
              <input type="checkbox" id="shelf_queen_mode">
              <label for="shelf_queen_mode">Enable shelf queen mode (driving simulation)</label>
            </div>
            <div>
              If enabled, the light controller simulates driving behavior and turns lights on and off
              when the &quot;no servo signal&quot; condition applies for more than 5 seconds.
            </div>
          </div>

          <h3>Gearbox servo output</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="gearbox_servo_active_time">
              <label for="gearbox_servo_active_time">servo activation time in ms</label>
            </div>

            <div>
             The value determines how long the gearbox servo is activated
             (= receives servo pulses) after a gear has changed or the idle
             time (see below) expires.
            </div>
          </div>
          <div class="advanced_feature">
            <div>
              <input type=number id="gearbox_servo_idle_time">
              <label for="gearbox_servo_idle_time">servo idle time in ms</label>
            </div>

            <div>
             The value determines for how long the gearbox servo stays idle
             (= servo pulses are turned off) when there is no gear change.
             This prevents the servo from being damaged due to the servo constantly
             pushing against mechanical stops of the gearbox.<br>
             Setting the value to 0 keeps the gearbox servo active at all times.<br>
            </div>
          </div>


          <h3>Gamma correction</h3>
          <div class="advanced_feature">
            <div>
              <input type=number id="gamma_value" min="0.0" max="9.9" step="0.1">
              <label for="gamma_value">gamma value</label>
            </div>

            <div>
              The current flowing through an LED determines its light output.
              However, the human perception is not linear to the amount of light.
              The light controller therefore offers a gamma correction so that
              if you set a light value of 50%, it should be roughly perceived
              has half as bright as the same LED set to 100%.<br>
              Useful values are between 1.8 and 2.2.
            </div>
          </div>

      </div>


      <div id="tab_programming" class="hidden">
        <div id="webusb_programmer_info" class="widebox configuration">
          <p>
          This programming function <strong>only works with the WebUSB programmer</strong> shown below.
          </p>
          <div class="webusb_programmer_image"></div>
          <p>
          When using the <strong>USB-to-Serial adapter</strong>, please use the <strong>LPC81x_ISP tool</strong>
          described in the <a target="_blank" href="https://laneboysrc.github.io/rc-light-controller/light-controller-instructions-mk4.pdf">light controller manual</a>.
          </p>
          <button id="close_webusb_programmer_info" title="Hide this message"><i class="fa fa-close"></i> Close</button>
        </div>

        <div id="error" class="box error hidden">
          <h1 style="color: white">Important</h1>
          <div id="error_https" class="hidden error_topic">
            <div>
              <strong>
                Run this program from <a href="https://laneboysrc.github.io/rc-light-controller/">https://laneboysrc.github.io/rc-light-controller</a>
              </strong>
            </div>
            <div>
              <strong>
                WebUSB does not work on <em>file:</em> or <em>http:</em> protocol (except when running on localhost)
                <br>
                For local testing use <em>python3 -m http.server</em> and browse to <em>http://localhost:8000</em>
              </strong>
            </div>
          </div>
          <div id="error_webusb" class="hidden error_topic">
            <strong>
              This web browser does not support the required <a target="_blank" href="https://caniuse.com/#search=webusb">WebUSB</a> function. A list of compatible browsers can be found at <a target="_blank" href="https://caniuse.com/#search=webusb">https://caniuse.com/#search=webusb</a>
            </strong>
          </div>
        </div>

        <div class="widebox configuration webusb_only">
          <div><span id="connection_info" class="hidden"></span> <button id="webusb_disconnect_button">Disconnect</button></div>
          <button id="webusb_connect_button">Connect</button>

        </div>

        <div class="widebox configuration webusb_only">
          <button id="program">Program</button>
          <div>
            <progress id="progress" max="100" value="0"></progress>
          </div>
        </div>

        <div class="widebox response webusb_only">
          <span style="float: right; font-size: 0.75em">
              (newest on top)
          </span>
          <h2>Diagnostic messages</h2>
          <div id="status"></div>
        </div>
      </div>


      <div id="tab_testing" class="hidden">

        <div id="error_testing" class="box error hidden">
          <h1 style="color: white">Warning</h1>
          <div id="error_baudrate" class="hidden error_topic">
              The Baudrate in the configuration is set to 38400, but this function
              can only work at 115200 Baud. Change the Baudrate temporarily for
              testing.
          </div>

          <div id="error_uart_in_use" class="hidden error_topic">
              The UART output is used in the configuration.
              Diagnostics messages will not be shown.
          </div>

          <div id="error_uart_on_out_isp" class="hidden error_topic">
              The UART output has been configured on the OUT/ISP pin.
              Diagnostics messages will not be shown.
          </div>

        </div>

        <div class="preprocessor-page" id="preprocessor-simulator">
            <div class="column">
                <div class="box configuration controls">
                    <h2>Steering</h2>
                    <div>
                        <input id="steering" type="range" min ="-100" max="100" step ="1" value ="0">
                        <div class="centered">
                            <button id="steering-neutral">center</button>
                        </div>
                    </div>
                    <h2>Throttle</h2>
                    <div>
                        <input id="throttle" type="range" min ="-100" max="100" step ="1" value ="0">
                        <div class="centered">
                            <button id="throttle-neutral">center</button>
                        </div>
                    </div>
                </div>
                <div class='box configuration controls expert'>
                    <h2>Expert settings</h2>
                    <div>
                        <input id='startup-mode' type='checkbox'> <label for='startup-mode'>Startup</label>
                    </div>
                    <div>
                        <input id='no-signal' type='checkbox'> <label for='no-signal'>Simulate no signal</label>
                    </div>
                    <div>
                      <label for='preprocessor-mode'>Pre-Processor protocol: </label> <select id='preprocessor-mode'>
                          <option value='0'>Automatic</option>
                          <option value='3'>3-channel</option>
                          <option value='5'>5-channel</option>
                      </select>
                    </div>
                </div>              </div>

            <div class='column'>
                <div class='box configuration controls'>
                    <span style='float: right;'>
                        <select id='aux-type'>
                            <option value='0'>Two-position switch</option>
                            <option value='1'>Two-position switch up/down</option>
                            <option value='2'>Momentary</option>
                            <option value='3' class='multi-aux'>Three-position switch</option>
                            <option value='4' class='multi-aux'>Analog</option>
                        </select>
                    </span>
                    <h2>AUX</h2>
                    <div id='aux-function' class='function'></div>
                    <div class='centered'>
                        <button id='aux-toggle'>AUX</button>
                    </div>
                    <input id='aux-slider' type='range' min ='-100' max='100' step ='1' value ='0'>
                </div>
                <div class='box configuration controls multi-aux'>
                    <span style='float: right;'>
                       <select id='aux2-type'>
                            <option value='0'>Two-position switch</option>
                            <option value='1'>Two-position switch up/down</option>
                            <option value='2'>Momentary</option>
                            <option value='3'>Three-position switch</option>
                            <option value='4'>Analog</option>
                        </select>
                    </span>
                    <h2>AUX2</h2>
                    <div id='aux2-function' class='function'></div>
                    <div class='centered'>
                        <button id='aux2-toggle'>AUX2</button>
                    </div>
                    <input id='aux2-slider' type='range' min ='-100' max='100' step ='1' value ='0'>
                </div>
                <div class='box configuration controls multi-aux'>
                    <span style='float: right;'>
                        <select id='aux3-type'>
                            <option value='0'>Two-position switch</option>
                            <option value='1'>Two-position switch up/down</option>
                            <option value='2'>Momentary</option>
                            <option value='3'>Three-position switch</option>
                            <option value='4'>Analog</option>
                        </select>
                    </span>
                    <h2>AUX3</h2>
                    <div id='aux3-function' class='function'></div>
                    <div class='centered'>
                        <button id='aux3-toggle'>AUX3</button>
                    </div>
                    <input id='aux3-slider' type='range' min ='-100' max='100' step ='1' value ='0'>
                </div>
            </div>
        </div>

        <div class="widebox response">
            <span style="float: right; font-size: 0.75em">
                (newest on top)
            </span>
            <h2>Diagnostics sent by the light controller</h2>
            <div class="message" id="diagnostics-messages"></div>
        </div>
      </div>


      <div id="info" class="box configuration hidden">
        <div>
          This tool would not have been possible without these awesome software components:
        </div>
        <div>
          <strong>CodeMirror</strong> <a href="http://codemirror.net/" target="_blank">http://codemirror.net/</a><br>
          A text editor in JavaScript. Very easy to use, yet extremely powerful.
          With little effort I could build custom syntax highlighting, and
          had error messages after the assembly process shown in the gutter.
        </div>
        <div>
          <strong>JISON</strong> <a href="https://zaach.github.io/jison/docs/" target="_blank">https://zaach.github.io/jison/docs/</a><br>
          Parser and scanner generator for JavaScript. It was very easy to adapt
          a prototype written in Bison/Flex to JISON.
        </div>
        <div>
          <strong>FileSaver.js</strong> <a href="https://github.com/eligrey/FileSaver.js/" target="_blank"></a><br>
          Allowed us to save generated JSON and Intel-hex files from within the
          browser.
        </div>
        <div>
          <strong>node.js</strong> <a href="http://nodejs.org" target="_blank">http://nodejs.org</a><br>
          Fantastic to have the same code work in the browser, and with the help
          of node.js also be able to use from the command-line.
        </div>
        <div>
          <strong>Font Awesome</strong> <a href="https://fontawesome.com/" target="_blank">https://fontawesome.com/</a><br>
          Beautiful and easy-to-use vector icons.
        </div>
        <div>
          <strong>intel-hex</strong> <a href="https://github.com/bminer/intel-hex.js" target="_blank">https://github.com/bminer/intel-hex.js</a><br>
          Good starting point for parsing Intel-hex files. I made it
          browser-compatible and added the missing write functions.
        </div>
        <div>
          <strong>Simple JavaScript Templating</strong> <a href="http://ejohn.org/" target="_blank">http://ejohn.org/</a><br>
          As the name says: a very simple templating engine.
        </div>
      </div>


    </div>
  </div>


  <input type="file" id="load_input" style="display:none">

  <div id="table_helper" style="visibility:hidden"></div>

  <!--
  This template is used by ui.js to build the table for master and slave
  LED configuration
  -->
  <script id="led_row_template" type="text/html-template">
    <tr class="led_config <%=even_odd%>" data-tooltip="help_click_to_change">
      <th data-tooltip="help_toggle_features"><%=led_number%> <i class="spanner led_table_car fa fa-wrench"></i></th>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
      <td class="led_table_car"></td>
    </tr>
    <tr data-tooltip="help_incandescent" class="<%=even_odd%> led_features <%=prefix%><%=led_index%>features hidden">
      <td colspan="16">
        <div>
          Incandescent light bulb simulation: <input type="number" min="0" max="100" class="incandescent" id="<%=prefix%><%=led_index%>incandescent"> % change per 20 ms
        </div>
      </td>
    </tr>
    <tr data-tooltip="help_weak_ground" class="<%=even_odd%> led_features <%=prefix%><%=led_index%>features hidden" >
      <td colspan="16">
        Weak ground simulation: <input type="number" min="0" max="100" class="weak_ground" id="<%=prefix%><%=led_index%>weak_ground"> % reduction
      </td>
    </tr>
    <tr data-tooltip="help_weak_ground" class="<%=even_odd%> led_features <%=prefix%><%=led_index%>features hidden">
      <td colspan="2"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox0"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox1"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox2"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox3"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox4"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox5"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox6"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox7"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox8"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox9"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox10"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox11"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox12"></td>
      <td><input type="checkbox" class="checkbox" id="<%=prefix%><%=led_index%>checkbox13"></td>
    </tr>
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function(event) {
      if (typeof(parser) === 'undefined') {
        var el = document.getElementById('runtime-error');

        el.style.display = "block";
      }
    });
  </script>

</body>
</html>

